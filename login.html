<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Login Redirect</title>
  <style>
        body {
      font-family: system-ui, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      background: #0D1B2A;
      color: #eee;
    }
    .box {
      text-align: center;
    }
    .spinner {
      /* border: 4px solid #eee; */
      border-top: 4px solid #00F5A0;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      margin: 0 auto 16px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="box">
    <div class="spinner"></div>
    <p id="status">Logging you in…</p>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    const supabase = createClient("https://supabase.rezemate.com", "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJzdXBhYmFzZSIsImlhdCI6MTc1OTI1Mjk4MCwiZXhwIjo0OTE0OTI2NTgwLCJyb2xlIjoiYW5vbiJ9.2MQamfKYk3O_Q5kDOPWlutMhFLQbE2LYupgxJQDtOCY");
    const appDeepLink = "Matico://login";

    async function handleLoginRedirect() {
      const url = window.location.href;
      const { data, error } = await supabase.auth.exchangeCodeForSession(url);

      if (error) {
        console.error("Auth error:", error);
        document.getElementById("status").textContent = "Login failed: " + (error.message || "Unknown error");
        return;
      }

      const { access_token, refresh_token } = data.session;
      const deepLinkUrl = `${appDeepLink}?access_token=${encodeURIComponent(access_token)}&refresh_token=${encodeURIComponent(refresh_token)}`;

      // Try opening the app
      window.location.href = deepLinkUrl;

      // Fallback after 1.5s: assume no app opened, show web success
      setTimeout(() => {
        document.querySelector(".spinner").style.display = "none";
        document.getElementById("status").textContent = "You’re logged in!";
      }, 1500);
    }

    handleLoginRedirect();
  </script>
</body>
</html>
